<html>

	<head>
		<title>Seventy Font Demo Page </title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			@font-face {
				font-family: 'Seventy';
				src: url(../build/Seventy-Regular.woff2?v=1.100) format('woff2');
				font-weight: 400;
				unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+0D01-0D7F, U+200C-U+200D, U+25CC;
			}


			body {
				margin: 1em;
				font-size: 1em;
				color: #333;
				line-height: 1.5em;
			}

			main {
				display: grid;
				grid-template-columns: minmax(0, 1fr) 20rem;
				overflow: hidden;
				height: 100%;
			}

			.content {
				display: flex;
				flex-direction: column;
				justify-content: center;
				text-align: center;
				font-family: 'Seventy', sans;
				padding: 0.5em;
				outline: none;
			}

			.tools {
				display: flex;
				flex-direction: column;
				font-family: sans;
				overflow: auto;
				font-size: 0.8em;
				color: #333;
			}

			.controls {
				margin: 0;
				padding: 0;

			}

			.controls.testcontent li {
				cursor: pointer;
				text-align: left;
				padding: 0 5px 0 0;
			}

			.controls.align {
				list-style: none;
				display: flex;
				flex-direction: row;
			}

			.controls.align li {
				width: 1.2em;
				height: 1.2em;
				cursor: pointer;
				margin-right: 1em;
			}

			footer {
				height: 20px;
				font-family: Arial, Helvetica, sans-serif;
				font-size: 8px;
				color: white;
			}

			.outline-text {
				color: orange;
				line-height: 1.5;
				text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
			}

			.rows {
				display: grid;
				column-gap: 1px;
				row-gap: 1em;
				margin-bottom: 1em;
				;
			}

			.rows>div {
				display: contents;
				margin-bottom: 1em;
			}

			.rows-2 {
				grid-template-columns: 2fr 5fr;
			}

			.rows-3 {
				grid-template-columns: auto 1fr auto;
			}

			.rows-1 {
				grid-template-columns: auto;
			}


			.val-input {
				width: 3.7rem;
				padding: 0;
				margin: 0;
			}

			#font-version:empty {
				display: none;
			}

			.blurry {
				filter: blur(2px);
				opacity: .9;
			}
		</style>
		<script>
			function loadFont(version){
				let font = new FontFace("Seventy", `url(../build/Seventy-Regular.woff2?v=${version}) format("woff2")`);
				font.load().then(function(loadedFont) {
					document.fonts.add(loadedFont);
				}).catch(console.error);
			}

			/**
			 * Shuffles array in place. ES6 version
			 * @param {Array} a items An array containing the items.
			 */
			function shuffle(a) {
				for (let i = a.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[a[i], a[j]] = [a[j], a[i]];
				}
				return a;
			}

			window.onload = () => {
				const contentArea = document.querySelector('.content')
				let testLines = [];
				let paragraphsMl = []
				let pangramsEn = []
				let paragraphsEn = []
				let currentTestIndex = 0;
				let testContents = []
				fetch('./content.txt').then(response => response.text()).then((content) => {
					testLines = shuffle(content.split("\n"));
					testLines = testLines.filter(testLine => !!testLine.trim())
					testContents = testLines;
					contentArea.innerHTML = testLines[currentTestIndex];

					contentArea.style.fontSize = document.querySelector('#font-fontSize').value;
					contentArea.style.lineHeight = document.querySelector('#font-lineHeight').value;
				})

				fetch('./paragraphs.malayalam.txt').then(response => response.text()).then((content) => {
					paragraphsMl = shuffle(content.split("\n"));
					paragraphsMl = paragraphsMl.filter(paragraph => !!paragraph.trim())
				});

				fetch('./paragraphs.english.txt').then(response => response.text()).then((content) => {
					paragraphsEn = shuffle(content.split("\n"));
					paragraphsEn = paragraphsEn.filter(paragraph => !!paragraph.trim())
				});

				fetch('./pangrams.txt').then(response => response.text()).then((content) => {
					pangramsEn = shuffle(content.split("\n"));
					pangramsEn = pangramsEn.filter(paragraph => !!paragraph.trim())
				});

				document.getElementById('test-content').addEventListener('change', function () {
					const selected = this.options[this.selectedIndex].value;
					if (selected == 'paragraphsEn') {
						testContents = paragraphsEn;
					}
					if (selected == 'paragraphsMl') {
						testContents = paragraphsMl;
					}
					if (selected == 'lines') {
						testContents = testLines;
					}
					if (selected == 'pangrams') {
						testContents = pangramsEn;
					}
					contentArea.innerHTML = testContents[0];
				});


				document.getElementById('next-test').addEventListener('click', () => {
					if (currentTestIndex + 1 >= testContents.length) {
						currentTestIndex = 0;
					}
					contentArea.innerHTML = testContents[++currentTestIndex];
				});

				document.getElementById('outlined').addEventListener('change', function () {
					const outlined = this.checked;
					if (outlined) {
						contentArea.classList.add('outline-text');
					} else {
						contentArea.classList.remove('outline-text');
					}
				});
				document.getElementById('squint').addEventListener('change', function () {
					const squint = this.checked;
					if (squint) {
						contentArea.classList.add('blurry');
					} else {
						contentArea.classList.remove('blurry');
					}
				});
				document.querySelectorAll('.controls.align > li').forEach((element) => {
					element.addEventListener('click', () => {
						contentArea.style.textAlign = element.dataset.align;
					});
				});

				document.querySelectorAll("[data-id='fontSize']").forEach((element) => {
					element.addEventListener('input', function () {
						const fontSize = element.value;
						if (element.type == 'range') {
							document.querySelector('#font-fontSize').value = fontSize;
						} else {
							document.querySelector('#font-size > input[type="range"]').value = fontSize;
						}
						contentArea.style.fontSize = fontSize;
					});
				});
				document.querySelectorAll("[data-id='lineHeight']").forEach((element) => {
					element.addEventListener('input', () => {
						const lineHeight = element.value;
						if (element.type == 'range') {
							document.querySelector('#font-lineHeight').value = lineHeight;
						} else {
							document.querySelector('#line-height > input[type="range"]').value = lineHeight;
						}
						contentArea.style.lineHeight = lineHeight;
					});
				});

				document.querySelectorAll("[data-id='letterSpacing']").forEach((element) => {
					element.addEventListener('input', () => {
						const letterSpacing = element.value;
						if (element.type == 'range') {
							document.querySelector('#font-letterSpacing').value = letterSpacing;
						} else {
							document.querySelector('#letter-spacing > input[type="range"]').value =
								letterSpacing;
						}
						contentArea.style.letterSpacing = letterSpacing;
					});
				});

				document.querySelectorAll("[data-id='fontColor']").forEach((element) => {
					element.addEventListener('input', function () {
						const fontColor = element.value;
						contentArea.style.color = fontColor;
					});
				});

				document.querySelectorAll("[name=opentype]").forEach((element) => {
					let otFeatures = {
						'kern': true,
						'blwf': true,
						'blws': true,
						'pref': true,
						'pres': true,
						'akhn': true,
						'pstf': true,
						'psts': true
					}

					element.addEventListener('change', function () {
						const checked = this.checked;
						otFeatures[element.value] = !!checked
						const fontFeatureSettings = [];
						for (let otFeature in otFeatures) {
							if (otFeatures.hasOwnProperty(otFeature) && !otFeatures[otFeature]) {
								fontFeatureSettings.push(`"${otFeature}" off`);
							}
						}
						contentArea.style.fontFeatureSettings = fontFeatureSettings.join(',');
					});
				});
			}

			const source = new EventSource('/stream');
			source.onmessage = (event) => {
				const message = JSON.parse(event.data);
				document.getElementById("font-version").innerText=`${message.fontname}: ${message.version}-${message.build}`
				loadFont(`${message.version}-${message.build}`)
			};

		</script>

	</head>

	<body>

		<main>
			<div contenteditable class="content">

			</div>
			<div class="tools">
				<h5 id="font-version"></h5>
				<section class="rows rows-3">
					<div class="primitive-input">
						<label for="font-fontSize">Font Size</label>
						<div id="font-size" class="slider">
							<input type="range" data-id="fontSize" value="90" min="8" step="1" max="256">
							<div class="progress" style="width: 21.4285714286%"></div>
						</div>
						<input type="number" class="font-size val-input" data-id="fontSize" value="90" min="8" step="1"
							max="120" id="font-fontSize">
					</div>

					<div class="primitive-input">
						<label for="font-lineHeight">Line Height</label>
						<div id="line-height" class="slider">
							<input type="range" data-id="lineHeight" value="1" min="0" max="3" step="0.01">
							<div class="progress" style="width: 50%"></div>
						</div>
						<input type="number" class="line-height val-input" value="1" data-id="lineHeight" min="0"
							max="3" step="0.1" id="font-lineHeight">
					</div>

					<div class="primitive-input">
						<label for="font-letterSpacing">Letter Spacing</label>
						<div id="letter-spacing" class="slider">
							<input type="range" data-id="letterSpacing" value="0" min="-7" max="7" step="0.01">
							<div class="progress" style="width: 50%"></div>
						</div>
						<input type="number" class="letter-spacing val-input" value="0" data-id="letterSpacing" min="-7"
							max="7" step="0.1" id="font-letterSpacing">
					</div>
					<div>
						<label for="test-content">Test content</label>
						<select class="controls testcontent" id="test-content">
							<option value="paragraphsMl">ഖണ്ഡികകൾ</option>
							<option value="paragraphsEn">Paragraphs</option>
							<option value="lines" selected>സിനിമാപ്പേരുകൾ</option>
							<option value="pangrams">Pangrams</option>
						</select>
						<span id="next-test" style="cursor: pointer;">
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
								<path
									d="M 35.3,12.7 C 32.41,9.8 28.42,8 24,8 15.16,8 8.02,15.16 8.02,24 c 0,8.84 7.14,16 15.98,16 7.45,0 13.69,-5.1 15.46,-12 H 35.3 c -1.65,4.66 -6.07,8 -11.3,8 -6.63,0 -12,-5.37 -12,-12 0,-6.63 5.37,-12 12,-12 3.31,0 6.28,1.38 8.45,3.55 L 26,22 H 40 V 8 Z"
									id="path2" />
								<path d="M 0,0 H 48 V 48 H 0 Z" fill="none" id="path4" />
							</svg>
						</span>
					</div>
				</section>
				<section class="rows rows-2">
					<div class="primitive-input">
						<label for="font-fontColor">Font color</label>
						<input type="color" class="font-color val-input" data-id="fontColor" id="font-fontColor">
					</div>
					<div>
						<label for="font-align">Text align</label>
						<ul class="controls align" id="font-align">
							<li data-align="left">
								<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
									<path d="M16.25 3.75H7.5V5H16.25V3.75Z"></path>
									<path d="M13.75 7.5H7.5V8.75H13.75V7.5Z"></path>
									<path d="M16.25 11.25H7.5V12.5H16.25V11.25Z"></path>
									<path d="M13.75 15H7.5V16.25H13.75V15Z"></path>
									<path d="M5 2.5H3.75V17.5H5V2.5Z"></path>
								</svg>
							</li>
							<li data-align="center">
								<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
									<path d="M16.25 3.75H3.75V5H16.25V3.75Z"></path>
									<path d="M13.75 7.5H6.25V8.75H13.75V7.5Z"></path>
									<path d="M16.25 11.25H3.75V12.5H16.25V11.25Z"></path>
									<path d="M13.75 15H6.25V16.25H13.75V15Z"></path>
								</svg>
							</li>
							<li data-align="right">
								<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
									<path d="M12.5 3.75H3.75V5H12.5V3.75Z"></path>
									<path d="M12.5 7.5H6.25V8.75H12.5V7.5Z"></path>
									<path d="M12.5 11.25H3.75V12.5H12.5V11.25Z"></path>
									<path d="M12.5 15H6.25V16.25H12.5V15Z"></path>
									<path d="M16.25 2.5H15V17.5H16.25V2.5Z"></path>
								</svg>
							</li>
						</ul>
					</div>
					<div>
						<label for="outlined"><input type="checkbox" id="outlined" name="fntstyle" value="outlined">
							⋒ Outline</label>

						<label for="squint"><input type="checkbox" id="squint" name="squint" value="squint">
							😉 Squint</label>
					</div>
				</section>

				<h5>Opentype features</h5>
				<section class="rows" style="grid-template-columns: 3fr auto;">
					<div>
						<label for="kern"><input type="checkbox" id="kern" name="opentype" value="kern" checked>
							Kerning</label>
						<span>kern</span>
					</div>
					<div>
						<label for="blwf"><input type="checkbox" id="blwf" name="opentype" value="blwf" checked>
							Below-base forms</label>
						<span>blwf</span>
					</div>
					<div>
						<label for="blws"><input type="checkbox" id="blws" name="opentype" value="blws" checked>
							Below-base substitutions</label>
						<span>blws</span>
					</div>
					<div>
						<label for="akhn"><input type="checkbox" id="akhn" name="opentype" value="akhn" checked> Akhand
							ligatures</label>
						<span>akhn</span>
					</div>
					<div>
						<label for="pref"><input type="checkbox" id="pref" name="opentype" value="pref" checked>
							Pre-base forms</label>
						<span>pref</span>
					</div>
					<div>
						<label for="pres"><input type="checkbox" id="pres" name="opentype" value="pres" checked>
							Pre-base substitutions</label>
						<span>pres</span>
					</div>
					<div>
						<label for="pstf"><input type="checkbox" id="pstf" name="opentype" value="pstf" checked>
							Post-base forms</label>
						<span>pstf</span>
					</div>
					<div>
						<label for="psts"><input type="checkbox" id="psts" name="opentype" value="psts" checked>
							Post-base substitutions</label>
						<span>psts</span>
					</div>
				</section>
			</div>
		</main>

</html>